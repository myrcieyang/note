<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>复古电脑备忘录 - 电源交互版</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Inter 字体和 VT323 字体 -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=VT323&family=Noto+Sans+SC:wght@700&display=swap" rel="stylesheet">
    
    <script type="module">
        /**
         * 复古电脑持久化系统 + 简化版电源管理（淡出启动版）
         * 修复：支持标题栏与内容区的动态焦点切换输入
         */

        const STORAGE_KEY = "motherPlanet_000765_log";
        const POWER_KEY = "motherPlanet_power_state";
        let localMemos = []; 
        let activeMemoId = null;
        let isPowerOn = localStorage.getItem(POWER_KEY) !== 'off'; 
        let isTransitioning = false;

        const memoTitleInput = () => document.getElementById('memo-title');
        const memoContentTextarea = () => document.getElementById('memo-content');
        const statusMessageElement = document.getElementById('status-message');
        const memoListElement = document.getElementById('memo-list');
        const memoViewElement = document.getElementById('memo-view');
        const managerViewElement = document.getElementById('manager-view');
        const memoIdDisplayElement = document.getElementById('memo-id-display');
        const powerOverlay = document.getElementById('power-overlay');
        const powerLoadingText = document.getElementById('power-loading-text');
        
        const KEY_MAP = {
            'Backquote': 'Key_Backquote', 'Digit1': 'Key_1', 'Digit2': 'Key_2', 'Digit3': 'Key_3', 'Digit4': 'Key_4',
            'Digit5': 'Key_5', 'Digit6': 'Key_6', 'Digit7': 'Key_7', 'Digit8': 'Key_8', 'Digit9': 'Key_9',
            'Digit0': 'Key_0', 'Minus': 'Key_Minus', 'Equal': 'Key_Equal', 'Backspace': 'Key_BACK', 'Enter': 'Key_ENTER',
            'Tab': 'Key_TAB', 'KeyQ': 'Key_Q', 'KeyW': 'Key_W', 'KeyE': 'Key_E', 'KeyR': 'Key_R',
            'KeyT': 'Key_T', 'KeyY': 'Key_Y', 'KeyU': 'Key_U', 'KeyI': 'Key_I', 'KeyO': 'Key_O',
            'KeyP': 'Key_P', 'BracketLeft': 'Key_BracketLeft', 'BracketRight': 'Key_BracketRight', 'Backslash': 'Key_Backslash',
            'ShiftLeft': 'Key_SHIFT_L', 'KeyA': 'Key_A', 'KeyS': 'Key_S', 'KeyD': 'Key_D', 'KeyF': 'Key_F',
            'KeyG': 'Key_G', 'KeyH': 'Key_H', 'KeyJ': 'Key_J', 'KeyK': 'Key_K', 'KeyL': 'Key_L',
            'Semicolon': 'Key_Semicolon', 'Quote': 'Key_Quote', 'ShiftRight': 'Key_SHIFT_R',
            'ControlLeft': 'Key_CTRL_L', 'AltLeft': 'Key_ALT_L', 'KeyZ': 'Key_Z', 'KeyX': 'Key_X', 
            'KeyC': 'Key_C', 'KeyV': 'Key_V', 'KeyB': 'Key_B', 'KeyN': 'Key_N', 'KeyM': 'Key_M',
            'Comma': 'Key_Comma', 'Period': 'Key_Period', 'Slash': 'Key_Slash', 
            'Space': 'Key_SPACEBAR', 'AltRight': 'Key_ALT_R', 'ControlRight': 'Key_PRINT',
            'PrintScreen': 'Key_PRINT'
        };

        // --- 核心电源控制逻辑 ---
        window.togglePower = async () => {
            if (isTransitioning) return;
            isTransitioning = true;
            
            const pwrBtn = document.getElementById('Key_PWR');
            pwrBtn.classList.add('key-pressed');

            if (isPowerOn) {
                setStatus("SHUTDOWN SEQUENCE...");
                powerOverlay.style.opacity = '1';
                powerOverlay.classList.remove('hidden');
                powerOverlay.style.backgroundColor = 'rgba(1, 23, 23, 0.7)'; 
                
                await animatePowerText("SHUTTING DOWN SYSTEM...");
                
                isPowerOn = false;
                localStorage.setItem(POWER_KEY, 'off');
                powerOverlay.style.backgroundColor = '#011717'; 
                powerLoadingText.innerHTML = ""; 
                setStatus("POWER: OFF");
            } else {
                setStatus("BOOT SEQUENCE...");
                powerOverlay.style.opacity = '1';
                powerOverlay.classList.remove('hidden');
                powerOverlay.style.backgroundColor = '#011717';
                powerLoadingText.innerHTML = "";
                
                await animatePowerText("SYSTEM STARTUP INITIALIZING...");
                
                isPowerOn = true;
                localStorage.setItem(POWER_KEY, 'on');
                
                powerOverlay.style.opacity = '0'; 
                
                setTimeout(() => {
                    powerOverlay.classList.add('hidden');
                    initApp(); 
                    setStatus("SYSTEM: ONLINE");
                }, 500);
            }
            
            setTimeout(() => {
                pwrBtn.classList.remove('key-pressed');
                isTransitioning = false;
            }, 200);
        };

        const animatePowerText = (text) => {
            return new Promise((resolve) => {
                let i = 0;
                powerLoadingText.innerHTML = "";
                const interval = setInterval(() => {
                    powerLoadingText.innerHTML = "> " + text.substring(0, i) + (i % 2 === 0 ? "_" : " ");
                    i++;
                    if (i > text.length) {
                        clearInterval(interval);
                        powerLoadingText.innerHTML = "> " + text + "<br>[ ########## ] 100%";
                        setTimeout(resolve, 800);
                    }
                }, 40);
            });
        };

        const syncToDisk = () => {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(localMemos));
                return true;
            } catch (e) { return false; }
        };

        const loadFromDisk = () => {
            const rawData = localStorage.getItem(STORAGE_KEY);
            if (rawData) {
                try {
                    const parsed = JSON.parse(rawData);
                    return parsed.map(m => ({ ...m, updated_at: new Date(m.updated_at) }));
                } catch (e) { return []; }
            }
            return [];
        };

        const setStatus = (message) => {
            if (statusMessageElement) { statusMessageElement.textContent = `状态: ${message}`; }
        };

        const setUiMode = (mode) => {
            if (!isPowerOn) return;
            if (mode === 'memo') {
                memoViewElement.classList.remove('hidden');
                managerViewElement.classList.add('hidden');
                memoContentTextarea().focus();
            } else if (mode === 'manager') {
                memoViewElement.classList.add('hidden');
                managerViewElement.classList.remove('hidden');
                fetchMemoList();
            }
        };

        // --- 修复后的输入函数 ---
        window.typeKey = (char) => {
            if (!isPowerOn || isTransitioning) return;
            
            // 获取当前焦点元素，如果不在标题也不在内容区，默认指向内容区
            const activeEl = document.activeElement;
            const target = (activeEl === memoTitleInput() || activeEl === memoContentTextarea()) 
                           ? activeEl 
                           : memoContentTextarea();

            if (!target || !managerViewElement.classList.contains('hidden')) return;
            
            const start = target.selectionStart;
            const end = target.selectionEnd;
            const value = target.value;
            let newValue = value;
            let newCursorPosition = start;

            if (char === 'BACK') {
                if (start !== end) {
                    newValue = value.substring(0, start) + value.substring(end);
                    newCursorPosition = start;
                } else if (start > 0) {
                    newValue = value.substring(0, start - 1) + value.substring(end);
                    newCursorPosition = start - 1;
                }
            } else if (char === 'ENTER') {
                // 标题栏不允许换行
                if (target !== memoTitleInput()) {
                    newValue = value.substring(0, start) + '\n' + value.substring(end);
                    newCursorPosition = start + 1;
                }
            } else if (char === 'TAB') {
                newValue = value.substring(0, start) + '    ' + value.substring(end);
                newCursorPosition = start + 4;
            } else if (!['SHIFT', 'CTRL', 'ALT', 'PRINT'].includes(char)) {
                newValue = value.substring(0, start) + char + value.substring(end);
                newCursorPosition = start + char.length;
            }
            
            target.value = newValue;
            target.selectionStart = target.selectionEnd = newCursorPosition;
            target.focus();
            debouncedSaveMemo();
        };

        const debouncedSaveMemo = (() => {
            let timeoutId;
            return () => {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    const titleInput = memoTitleInput();
                    const contentTextarea = memoContentTextarea();
                    if (contentTextarea && titleInput && activeMemoId) {
                        const index = localMemos.findIndex(m => m.id === activeMemoId);
                        const data = { 
                            id: activeMemoId, 
                            content: contentTextarea.value, 
                            title: titleInput.value || '未命名', 
                            updated_at: new Date() 
                        };
                        if (index > -1) localMemos[index] = data; else localMemos.push(data);
                        syncToDisk();
                        setStatus(`SYNC OK: [${data.title}]`);
                    }
                }, 1000);
            };
        })();

        const loadMemo = (memoId) => {
            if (!isPowerOn) return;
            activeMemoId = memoId;
            const memo = localMemos.find(m => m.id === memoId);
            if (memo) {
                memoTitleInput().value = memo.title;
                memoContentTextarea().value = memo.content;
                memoIdDisplayElement.textContent = `> [ ID: ${memoId.substring(0, 8)}... ]`;
                setUiMode('memo');
            }
        };

        const fetchMemoList = (loadFirst = false) => {
            const memos = [...localMemos].sort((a, b) => b.updated_at - a.updated_at);
            memoListElement.innerHTML = memos.length === 0 ? `<p class="text-cyan-500 font-mono p-2">>>> NO LOGS FOUND.</p>` : '';
            memos.forEach(memo => {
                const isActive = memo.id === activeMemoId;
                const item = document.createElement('div');
                item.className = 'group flex justify-between items-center p-2 border-b border-cyan-800 text-cyan-300 font-mono';
                const titleSpan = document.createElement('span');
                titleSpan.className = `cursor-pointer truncate flex-grow p-1 ${isActive ? 'bg-cyan-700/50' : 'hover:bg-cyan-700'}`;
                titleSpan.textContent = `${memo.title} (${new Date(memo.updated_at).toLocaleDateString()})`;
                titleSpan.onclick = () => loadMemo(memo.id);
                const delBtn = document.createElement('span');
                delBtn.className = 'text-red-500 cursor-pointer ml-4 px-1 hover:bg-red-900';
                delBtn.textContent = '[X]';
                delBtn.onclick = (e) => {
                    e.stopPropagation();
                    localMemos = localMemos.filter(m => m.id !== memo.id);
                    syncToDisk();
                    fetchMemoList(activeMemoId === memo.id);
                };
                item.append(titleSpan, delBtn);
                memoListElement.appendChild(item);
            });
            if (loadFirst && memos.length > 0) loadMemo(memos[0].id);
            else if (loadFirst && memos.length === 0) window.newMemo();
        };

        window.newMemo = () => {
            if (!isPowerOn) return;
            const newId = crypto.randomUUID();
            localMemos.push({ 
                id: newId, 
                title: `新建备忘录 ${new Date().toLocaleTimeString('zh-CN')}`,
                content: "",
                updated_at: new Date()
            });
            syncToDisk();
            loadMemo(newId);
            fetchMemoList();
        };

        const initApp = () => {
            if (!isPowerOn) {
                powerOverlay.classList.remove('hidden');
                powerOverlay.style.backgroundColor = '#011717';
                powerLoadingText.innerHTML = "";
                setStatus("POWER: OFF");
                return;
            }
            localMemos = loadFromDisk();
            fetchMemoList(true); 
            memoContentTextarea()?.addEventListener('input', debouncedSaveMemo);
            memoTitleInput()?.addEventListener('input', debouncedSaveMemo);
        };

        window.onload = () => {
            document.addEventListener('keydown', (e) => {
                const virtualKeyId = KEY_MAP[e.code];
                if (virtualKeyId) document.getElementById(virtualKeyId)?.classList.add('key-pressed');
                if (!isPowerOn) return;
                
                // 处理 Backspace, Enter, Tab 拦截逻辑，确保对标题栏也生效
                const activeEl = document.activeElement;
                if (['Backspace', 'Enter', 'Tab'].includes(e.code) && 
                    (activeEl === memoContentTextarea() || activeEl === memoTitleInput())) {
                    e.preventDefault();
                    window.typeKey(e.code === 'Backspace' ? 'BACK' : e.code.toUpperCase());
                }
            });
            document.addEventListener('keyup', (e) => {
                document.getElementById(KEY_MAP[e.code])?.classList.remove('key-pressed');
            });
            initApp();
        };
        window.openFileManager = () => setUiMode('manager');
        window.setUiMode = setUiMode;
    </script>
    <style>
        body { font-family: 'Inter', 'Noto Sans SC', sans-serif; background-color: #1a202c; }
        .crt-screen {
            background-color: #011717; 
            box-shadow: inset 0 0 15px rgba(64, 224, 208, 0.7); 
            position: relative;
            color: #40E0D0; 
            font-family: 'VT323', 'Noto Sans SC', monospace; 
            font-weight: 700;
            line-height: 1.2; 
            border-radius: 4px;
            transform: skewX(-0.5deg);
            overflow: hidden;
            letter-spacing: 2px;
        }
        .crt-screen::after {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;
            background: repeating-linear-gradient(to bottom, transparent 0, transparent 1px, rgba(0, 0, 0, 0.4) 1px, rgba(0, 0, 0, 0.4) 3px);
            mix-blend-mode: overlay; opacity: 0.6; z-index: 100;
        }
        .crt-textarea {
            background: transparent; color: inherit; resize: none; width: 100%; height: 100%; border: none; outline: none;
            caret-color: #40E0D0; white-space: pre-wrap; font-size: 22px; 
            text-shadow: 0 0 3px rgba(64, 224, 208, 1);
        }
        .crt-title-input {
            background: transparent; color: #40E0D0; font-family: 'VT323', 'Noto Sans SC', monospace; 
            font-size: 22px; font-weight: 700; border: none; outline: none;
            text-shadow: 0 0 3px rgba(64, 224, 208, 1);
        }
        .rounded-retro { border-radius: 1.5rem; box-shadow: 0 12px 25px rgba(0, 0, 0, 0.4), inset 0 1px 0 #ffffff, inset 0 -4px 0 #b4b4b4; }
        .key-row div { flex-grow: 1; height: 28px; background-color: #d1d5db; border-radius: 4px; box-shadow: 0 4px 0 0 #57534e; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 700; color: #44403c; }
        .key-row div:active, .key-pressed { transform: translateY(2px); box-shadow: 0 2px 0 0 #57534e !important; background-color: #c0c2c5 !important; }
        
        #power-overlay { 
            z-index: 80; 
            transition: opacity 0.5s ease-out, background-color 0.3s ease; 
        }
        #power-loading-text { font-family: 'VT323', monospace; font-size: 1.5rem; color: #40E0D0; text-shadow: 0 0 5px #40E0D0; }
    </style>
</head>
<body class="p-4 sm:p-8 flex justify-center items-start min-h-screen">
    <div class="w-full max-w-4xl space-y-6">
        <div class="bg-stone-200 p-6 sm:p-8 rounded-retro border-4 border-stone-400 relative">
            <div class="bg-stone-400 p-3 sm:p-4 rounded-lg shadow-inner border-2 border-stone-500">
                <div class="crt-screen w-full h-[300px] sm:h-[400px]">
                    <div class="w-full h-full p-6 relative">
                        
                        <!-- 电源遮罩 -->
                        <div id="power-overlay" class="hidden absolute inset-0 flex flex-col justify-center items-center p-12">
                            <div id="power-loading-text" class="text-center"></div>
                        </div>

                        <!-- 备忘录视图 -->
                        <div id="memo-view" class="w-full h-full flex flex-col">
                            <input id="memo-title" type="text" placeholder="任务日志标题..." class="crt-title-input w-full flex-shrink-0">
                            <div class="border-t border-cyan-800 mt-2 mb-2"></div>
                            <textarea id="memo-content" placeholder="请在此输入文本..." class="crt-textarea flex-grow mt-4"></textarea>
                            <div class="flex-shrink-0 mt-2 flex justify-between text-sm">
                                <span id="memo-id-display">> [ ID: LOG-STABLE ]</span>
                                <span class="cursor-pointer hover:underline text-cyan-500" onclick="window.openFileManager()">[文件管理/存档]</span>
                            </div>
                        </div>

                        <!-- 文件管理 -->
                        <div id="manager-view" class="hidden w-full h-full absolute inset-0 p-6 flex flex-col justify-between">
                            <h2 class="text-xl text-cyan-500 mb-4 border-b border-cyan-800 pb-2">>>> DISK MANAGER V1.0</h2>
                            <div id="memo-list" class="flex-grow overflow-y-auto border border-cyan-700 p-2 mb-4"></div>
                            <div class="flex-shrink-0 flex space-x-2 mt-4">
                                <span onclick="window.newMemo()" class="cursor-pointer hover:bg-cyan-700 p-1 bg-cyan-900 text-white w-1/2 text-center">[新建文档]</span>
                                <span onclick="window.setUiMode('memo')" class="cursor-pointer hover:bg-red-700 p-1 bg-red-900 text-white w-1/2 text-center">[返回终端]</span>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
            <div class="flex justify-between items-center mt-4 text-stone-700 text-xs font-mono">
                <span id="status-message">> 状态: 运行中...</span>
                <div class="flex space-x-2">
                    <div class="w-3 h-3 rounded-full bg-cyan-500 shadow-lg shadow-cyan-500/80"></div>
                    <div class="w-3 h-3 rounded-full bg-red-500 shadow-lg shadow-red-500/80 opacity-75"></div>
                </div>
            </div>
        </div>

        <div class="bg-stone-200 p-4 sm:p-6 rounded-retro border-4 border-stone-400 mt-6">
            <div class="text-stone-700 text-sm mb-3 font-mono">KEYBOARD UNIT - ACTIVE</div>
            <div class="space-y-1">
                <div class="flex space-x-1 key-row">
                    <div class="rounded-sm bg-gray-600 text-gray-300">ESC</div>
                    <div>F1</div><div>F2</div><div>F3</div><div>F4</div><div>F5</div><div>F6</div><div>F7</div><div>F8</div><div>F9</div><div>F10</div><div>F11</div><div>F12</div><div>DEL</div>
                    <div id="Key_PWR" class="rounded-sm bg-red-800 text-white font-bold" onclick="window.togglePower()">PWR</div>
                </div>
                <div class="flex space-x-1 key-row">
                    <div id="Key_Backquote" onclick="typeKey('`')">~</div><div id="Key_1" onclick="typeKey('1')">1</div><div id="Key_2" onclick="typeKey('2')">2</div><div id="Key_3" onclick="typeKey('3')">3</div><div id="Key_4" onclick="typeKey('4')">4</div><div id="Key_5" onclick="typeKey('5')">5</div><div id="Key_6" onclick="typeKey('6')">6</div><div id="Key_7" onclick="typeKey('7')">7</div><div id="Key_8" onclick="typeKey('8')">8</div><div id="Key_9" onclick="typeKey('9')">9</div><div id="Key_0" onclick="typeKey('0')">0</div><div id="Key_Minus" onclick="typeKey('-')">-</div><div id="Key_Equal" onclick="typeKey('=')">=</div><div id="Key_BACK" onclick="typeKey('BACK')">BACK</div><div id="Key_ENTER" class="bg-cyan-700 text-white" onclick="typeKey('ENTER')">ENTER</div>
                </div>
                <div class="flex space-x-1 key-row">
                    <div id="Key_TAB" onclick="typeKey('TAB')">TAB</div><div id="Key_Q" onclick="typeKey('Q')">Q</div><div id="Key_W" onclick="typeKey('W')">W</div><div id="Key_E" onclick="typeKey('E')">E</div><div id="Key_R" onclick="typeKey('R')">R</div><div id="Key_T" onclick="typeKey('T')">T</div><div id="Key_Y" onclick="typeKey('Y')">Y</div><div id="Key_U" onclick="typeKey('U')">U</div><div id="Key_I" onclick="typeKey('I')">I</div><div id="Key_O" onclick="typeKey('O')">O</div><div id="Key_P" onclick="typeKey('P')">P</div><div id="Key_BracketLeft" onclick="typeKey('[')">[</div><div id="Key_BracketRight" onclick="typeKey(']')">]</div><div id="Key_Backslash" onclick="typeKey('\\')">\</div>
                </div>
                <div class="flex space-x-1 key-row">
                    <div id="Key_SHIFT_L" onclick="typeKey('SHIFT')">SHIFT</div><div id="Key_A" onclick="typeKey('A')">A</div><div id="Key_S" onclick="typeKey('S')">S</div><div id="Key_D" onclick="typeKey('D')">D</div><div id="Key_F" onclick="typeKey('F')">F</div><div id="Key_G" onclick="typeKey('G')">G</div><div id="Key_H" onclick="typeKey('H')">H</div><div id="Key_J" onclick="typeKey('J')">J</div><div id="Key_K" onclick="typeKey('K')">K</div><div id="Key_L" onclick="typeKey('L')">L</div><div id="Key_Semicolon" onclick="typeKey(';')">;</div><div id="Key_Quote" onclick="typeKey('\'')">"</div>
                </div>
                <div class="flex space-x-1 key-row">
                    <div id="Key_CTRL_L" onclick="typeKey('CTRL')">CTRL</div><div id="Key_ALT_L" onclick="typeKey('ALT')">ALT</div><div id="Key_Z" onclick="typeKey('Z')">Z</div><div id="Key_X" onclick="typeKey('X')">X</div><div id="Key_C" onclick="typeKey('C')">C</div><div id="Key_V" onclick="typeKey('V')">V</div><div id="Key_B" onclick="typeKey('B')">B</div><div id="Key_N" onclick="typeKey('N')">N</div><div id="Key_M" onclick="typeKey('M')">M</div><div id="Key_Comma" onclick="typeKey(',')">,</div><div id="Key_Period" onclick="typeKey('.')">.</div><div id="Key_Slash" onclick="typeKey('/')">/</div><div id="Key_SPACEBAR" class="bg-gray-400" onclick="typeKey(' ')">SPACEBAR</div><div id="Key_PRINT" onclick="setStatus('正在截屏...')">PRINT</div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>